---
title: "ãƒ¬ã‚¤ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°(12): é›†å…‰æ¨¡æ§˜!"
emoji: "ğŸ’¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Haskell", "RayTracing", "PhotonMapping"]
published: true
---
(ã“ã®è¨˜äº‹ã¯Qiitaã‹ã‚‰ã®è»¢è¼‰ã§ã™)

ãƒ¬ã‚¤ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ï¼š[ç›®æ¬¡](https://zenn.dev/eijian/articles/raytracing-index-20220814)

## 1. ä»Šå›ã®æ”¹å–„

ä»Šå›ã¯ã‚„ã£ã¨ç›®æ¨™ã ã£ãŸé›†å…‰æ¨¡æ§˜ã®å®Ÿç¾ã«å–ã‚Šçµ„ã‚€ã“ã¨ã«ã™ã‚‹ã€‚ã¾ãŸã€ã¤ã„ã§ã«çƒä»¥å¤–ã®å½¢çŠ¶ã®ã‚µãƒãƒ¼ãƒˆã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¯¾å¿œã‚‚ã‚„ã£ã¦ã¿ãŸã€‚

### -1. Materialå‹

ã¾ãšæœ€åˆã«`Material`å‹ã®æ‹¡å¼µã«ã¤ã„ã¦èª¬æ˜ã—ãŸã„ã€‚`Material`å‹ã¯ç‰©ä½“ã®ç‰©æ€§ã‚„æ¨¡æ§˜ã‚’è¡¨ã™ãŸã‚ã«å®šç¾©ã—ãŸå‹ã ã€‚å‰å›ã¾ã§ã¯å˜ç´”ãªå®Œå…¨æ‹¡æ•£é¢ã‚’æƒ³å®šã—ã¦ã„ãŸãŸã‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å°‘ã—ã—ã‹ãªã‹ã£ãŸï¼ˆã‚³ãƒ¼ãƒ‰è‡ªä½“ã«ã¯æ›¸ã„ã¦ã„ã¦ã‚‚ä½¿ã£ã¦ã„ãªã„ã‚‚ã®ã‚‚ã‚ã£ãŸï¼‰ã€‚é¡é¢åå°„ãƒ»å±ˆæŠ˜ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã«ã‚ãŸã‚Šã„ãã¤ã‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ãŸã—ã€å®Ÿéš›ã«å€¤ã‚’ä½¿ã†ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’æ‹¡å¼µã—ãŸã€‚ä¸‹è¡¨ã«å¾“æ¥ã¨ä»Šå›ã®å¯¾å¿œã‚’ç¤ºã™ã€‚

|parameter    |å‹    |èª¬æ˜|å‰å›ç‰ˆ|ä»Šå›|
|:-:|:-:|:-:|:-:|:-:|
|emittance    |Radiance|è‡ªå·±ç™ºå…‰å¼·åº¦|â—‹|â—‹|
|reflectance  |Color   |æ‹¡æ•£åå°„ç‡(â‰’ç‰©ä½“è‰²?)|â—‹|â—‹|
|specularRefl |Color   |é¡é¢åå°„ç‡(é‡‘å±åå°„)|-|â—‹|
|transmittance|Color   |é€éç‡|-|-|
|ior          |Color   |å±ˆæŠ˜ç‡|-|â—‹|
|diffuseness  |Double  |æ‹¡æ•£åº¦â€»1|â—‹|â—‹|
|metalness    |Double  |é‡‘å±æ€§â€»2|-|â—‹|
|smoothness   |Double  |å¹³æ»‘åº¦|-|-|

> â€»1: æ‹¡æ•£åå°„ã¨é¡é¢åå°„ã®å‰²åˆã‚’è¡¨ã™ã€‚1.0ã ã¨å®Œå…¨æ‹¡æ•£åå°„ã€0.0ã ã¨å®Œå…¨é¡é¢åå°„ã¨ãªã‚‹ã€‚é¡é¢åå°„æ–¹å‘ã‹ã‚‰ã®å…‰ã‚’ã©ã‚Œã ã‘åå°„ã™ã‚‹ã‹ã€‚

> â€»2: é‡‘å±æ€§ã¨æ›¸ã„ãŸãŒé‡‘å±åå°„ã¨é€éã®å‰²åˆã‚’è¡¨ã™ã€‚1.0ã ã¨å®Œå…¨ã«ä¸é€æ˜ã§é‡‘å±åå°„ã®ã¿ã€0.0ã ã¨ã‚¬ãƒ©ã‚¹ã®ã‚ˆã†ãªé€æ˜ç‰©ä½“ã¨ãªã‚‹ã€‚

ãªãŠã€ã¾ã å¯¾å¿œã§ãã¦ã„ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚ã‚ã‚‹ã€‚`transmittance`ã¯é€æ˜ç‰©è³ªå†…ã§ã®å…‰ã®é€šéå‰²åˆã§ã€è‰²ã‚¬ãƒ©ã‚¹ã®ã‚ˆã†ãªç‰©ä½“ã‚’è¡¨ã™ãŸã‚ã€`smoothness`ã¯è¡¨é¢ã®ã–ã‚‰ã¤ãå…·åˆã§ã¼ã‚„ã‘ãŸãƒã‚¤ãƒ©ã‚¤ãƒˆãªã©ã‚’è¡¨ã™ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã ã€‚ãœã²ã¨ã‚‚ã“ã‚Œã‚‰ã‚‚å®Ÿè£…ã—ãŸã„ãŒã€ä»Šå¾Œã®èª²é¡Œã¨ã™ã‚‹ã€‚

`ior`ã®å‹ãŒ`Color`ã«ãªã£ã¦ã„ã‚‹ã®ã¯ã€è‰²ï¼ˆå…‰ã®æ³¢é•·ï¼‰æ¯ã«å±ˆæŠ˜ç‡ãŒé•ã†å ´åˆãŒã‚ã‚‹ãŸã‚ã€‚ä¸‰è§’ãƒ—ãƒªã‚ºãƒ ã«ã‚ˆã‚‹å…‰ã®åˆ†æ•£ã‚’å†ç¾ã™ã‚‹ãŸã‚ã«å¿…è¦ã ã€‚ï¼ˆã¨ã¯ã„ãˆã€ç¾çŠ¶ã¯èµ¤ã€ç·‘ã€é’ã®3æ³¢é•·ã—ã‹æ‰±ã£ã¦ã„ãªã„ãŸã‚ã€ã„ã‚ã‚†ã‚‹è™¹è‰²ã«ãªã‚‰ãªã„ãŒï¼‰

å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã©ã®ã‚ˆã†ã«ä½¿ã‚ã‚Œã‚‹ã‹ã¯å¾Œã®ç¯€ã§èª¬æ˜ã™ã‚‹ã€‚

### -2. é¡é¢åå°„ãƒ»å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«

åå°„ãƒ»å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«ã®æ±‚ã‚æ–¹ã«ã¤ã„ã¦ã¯ã€ã„ã‚ã„ã‚ãªã¨ã“ã‚ã«æƒ…å ±ãŒã‚ã‚‹ã®ã§ã“ã“ã§ã¯å‰²æ„›ã—ã€æ•°å¼ã¨ã‚³ãƒ¼ãƒ‰ã®ã¿ç¤ºã™ã“ã¨ã«ã—ã‚ˆã†ã€‚å„è¨˜å·ãƒ»æ–‡å­—ãŒã‚ã‹ã‚Šæ˜“ã„ã‚ˆã†ã«ã€å…¨ä½“ã‚’å›³ã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚

![11-vector.png](/images/raytracing-12/11-vector.png)


#### (åå°„)

å…¥å°„ãƒ™ã‚¯ãƒˆãƒ« $\boldsymbol{e}$ ã€æ³•ç·šãƒ™ã‚¯ãƒˆãƒ« $\boldsymbol{n}$ ã¨ã™ã‚‹æ™‚ã€æ±‚ã‚ã‚‹åå°„ãƒ™ã‚¯ãƒˆãƒ«$\boldsymbol{v_r}$ ã¯ã€

$$
\boldsymbol{v_r} = \boldsymbol{e} - 2 \langle \boldsymbol{e}, \boldsymbol{n} \rangle \boldsymbol{n}
$$

ã§ã‚ã‚‹ã€‚ãŸã ã—ã€$\boldsymbol{e}, \boldsymbol{n}$ ã¯æ­£è¦åŒ–(=é•·ã•ãŒ1)ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®é€šã‚Šã€‚

```haskell:Geometry.hs
specularReflection :: Direction3 -> Direction3 -> (Direction3, Double)
specularReflection n e
  | v == Nothing = (n, 0.0)
  | c < 0.0      = (fromJust v, -c)
  | otherwise    = (fromJust v,  c)
  where
    c = e <.> n
    v = normalize (e - (2.0 * c) *> n)
```

ã¾ã‚ã€ã‚³ãƒ¼ãƒ‰ã¯ä¸Šå¼ã‚’ãã®ã¾ã¾è¡¨ç¾ã—ãŸã ã‘ã§ã‚ã‚‹ã€‚æˆ»ã‚Šå€¤ã¯åå°„ãƒ™ã‚¯ãƒˆãƒ«ã®ä»–ã«å†…ç© $\langle \boldsymbol{e}, \boldsymbol{n} \rangle$ ã™ãªã‚ã¡ $\cos \theta$( $\theta$ ã¯$\boldsymbol{e}$ ã¨ $\boldsymbol{n}$ ã®ãªã™è§’) ã‚‚å«ã‚ã¦ã„ã‚‹ã€‚$\cos \theta$ ã¯ã‚ã¨ã§ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã®ã ã€‚

#### (å±ˆæŠ˜)

çµ¶å¯¾å±ˆæŠ˜ç‡ $\eta_1$ ã®ç‰©è³ªã‹ã‚‰çµ¶å¯¾å±ˆæŠ˜ç‡ $\eta_2$ ã®ç‰©è³ªã«å…‰ãŒå…¥å°„ã—ãŸå ´åˆã€å…¥å°„è§’ $\theta$ ã«å¯¾ã—ã€å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«ã®è§’åº¦ãŒæ³•ç·šã«å¯¾ã—ã¦ $\phi$ ã¨ã™ã‚‹ã¨ãã‚Œã‚‰ã®é–“ã«ã¯ä»¥ä¸‹ã®é–¢ä¿‚ãŒæˆã‚Šç«‹ã¤ã¨ã„ã†(ç†å±ˆã¯ã‚ˆãã‚ã‹ã£ã¦ã„ãªã„)ã€‚

$$
\eta_1 \sin \theta = \eta_2 \sin \phi
$$

ã“ã®é–¢ä¿‚å¼ã‚’ä½¿ã†ã¨ã€ï¼ˆé€”ä¸­ã®å¼å¤‰å½¢ãªã©ã¯ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒï¼‰å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«
 $\boldsymbol{v_t}$ ã¯æ¬¡ã®å¼ã§æ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚

$$
\boldsymbol{v_t} = \frac{\eta_1}{\eta_2} \left( \boldsymbol{e} + \left( \cos \theta - \sqrt{{\left( \frac{\eta_2}{\eta_1} \right)}^2 + {\cos}^2 \theta - 1} \right) \boldsymbol{n} \right)
$$

ã“ã“ã§ $\cos \theta$ ã¯åå°„ã®ã¨ãã¨åŒã˜ã€‚ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã€‚

```haskell:Geometry.hs
specularRefraction :: Double -> Double -> Double -> Direction3 -> Direction3
                   -> (Direction3, Double)
specularRefraction ior0 ior1 c0 ed n
  | r <  0.0     = (o3, 0.0)
  | t == Nothing = (o3, 0.0)
  | otherwise    = (fromJust t, ior')
  where
    ior' = ior0 / ior1
    r = 1.0 / (ior' * ior') + c0 * c0 - 1.0
    a = c0 - sqrt r
    n' = if ed <.> n > 0.0 then negate n else n
    t = normalize (ior' *> (ed + a *> n'))
```

å¼•æ•°ã®`ior0`ã€`ior1`ã€`c0`ã¯æ•°å­—ãŒç´›ã‚‰ã‚ã—ã„ãŒãã‚Œãã‚Œ $\eta_1$, $\eta_2$,$\cos \theta$ã‚’æ„å‘³ã™ã‚‹ã€‚`ed`ã¯å…¥å°„ãƒ™ã‚¯ãƒˆãƒ« $\boldsymbol{e}$ ã§ã‚ã‚‹ã€‚`where`ç¯€ã‚’å°‘ã—èª¬æ˜ã—ã‚ˆã†ã€‚å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«ã‚’æ±‚ã‚ã‚‹å¼ä¸­ã«å¹³æ–¹æ ¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã€‚ã“ã®ä¸­èº«ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹å ´åˆã€å…‰ã¯å…¨åå°„ã™ã‚‹ï¼ˆï¼å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«ã¯å­˜åœ¨ã—ãªã„ï¼‰ã€‚
ã“ã‚Œã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã€ä¸€æ—¦å¹³æ–¹æ ¹ã®ä¸­èº«ã‚’`r`ã¨ã—ã€ã‚¬ãƒ¼ãƒ‰ã§ãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯é›¶ãƒ™ã‚¯ãƒˆãƒ«ã‚’è¿”ã—ã¦ã„ã‚‹ã€‚ã•ã¦ã€å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«ã‚’æ±‚ã‚ã‚‹ã«ã¯å…¥å°„å…‰ãŒé€šã£ã¦ããŸã®ã¨åŒã˜å´ã«å‘ã„ãŸæ³•ç·šãƒ™ã‚¯ãƒˆãƒ«ãŒå¿…è¦ã ãŒã€æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯äº¤ç‚¹ã§ã®æ³•ç·šã¯å¸¸ã«ç‰©ä½“ã®ã€Œå¤–å´ã€ã«å‘ãã‚ˆã†å®šç¾©ã—ã¦ã„ã‚‹ã€‚ã¤ã¾ã‚Šçƒãªã‚‰è¡¨é¢ã‹ã‚‰å¤–å´ã«æ³•ç·šãƒ™ã‚¯ãƒˆãƒ«ãŒå‘ãã€‚ã—ã‹ã—å±ˆæŠ˜ã§ã¯ç‰©ä½“å†…éƒ¨ã‚’å…‰ãŒé€šã£ã¦ç‰©ä½“è¡¨é¢ã«ã¦åå°„ã¨å±ˆæŠ˜ãŒèµ·ãã‚‹ã€‚ã“ã®å ´åˆã€åå°„å±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«ã®è¨ˆç®—ã«å¿…è¦ãªã®ã¯ç‰©ä½“ã®å†…å´ã«å‘ã„ãŸæ³•ç·šãƒ™ã‚¯ãƒˆãƒ«ã§ã‚ã‚‹ã€‚ãã®ãŸã‚ã‚ã–ã‚ã– $\cos \theta$ ã®ç¬¦å·ã‚’ã¿ã¦ $\boldsymbol{n}$ ã‚’åè»¢ã•ã›ã¦ã„ã‚‹(`n'`)ã€‚ã“ã®ã“ã¨ã¯å±ˆæŠ˜ã ã‘ã§ãªãåå°„ã‚‚åŒã˜ã ãŒã€ã‚¬ãƒ¼ãƒ‰ã«ã‚ˆã‚‹æ¡ä»¶åˆ†å²ã§æ¸ˆã¾ã—ã¦ã„ã‚‹ã€‚ã‚ã¨ã¯ä¸Šè¿°ã®æ•°å¼é€šã‚Šãªã®ã§ç‰¹ã«å•é¡Œãªã„ã ã‚ã†ã€‚å±ˆæŠ˜ã¯ãŠã¾ã‘ã¨ã—ã¦æ¯”å±ˆæŠ˜ç‡($\frac{\eta_1}{\eta_2}$)ã‚‚æˆ»ã‚Šå€¤ã«å…¥ã‚Œã¦ã„ã‚‹ã€‚

#### (Schlickã®è¿‘ä¼¼å¼)

é¡é¢åå°„ãƒ»å±ˆæŠ˜ã§ã¯ã€ç‰©ä½“è¡¨é¢ã®åå°„ç‡ãŒå…¥å°„è§’ã«ã‚ˆã‚Šå¤‰åŒ–ã™ã‚‹ã€‚æ­£ç¢ºã«ã¯Fresnelã®å…¬å¼ã¨ã„ã†ã®ã§æ±‚ã‚ã‚‹ã®ã ãŒã€ã“ã‚ŒãŒãªã‹ãªã‹ã‚„ã‚„ã“ã—ã„ã€‚ãŠãã‚‰ãè¨ˆç®—è² è·ã‚‚é«˜ã„ã€‚ãã“ã§ä¾¿åˆ©ãª"Schlickã®è¿‘ä¼¼å¼"ã¨ã„ã†ã®ã‚’ä»£ã‚ã‚Šã«ä½¿ã†ãã†ã ã€‚

$$
F_r \approx F_0 + (1 - F_0) {(1 - \cos \theta)}^5
$$

ã“ã“ã§ã€$F_0$ ã¯ç‰©è³ªã®æ³•ç·šæ–¹å‘ã‹ã‚‰ã®å…‰ã®åå°„ç‡ã§ã‚ã‚‹ã€‚ç‰©è³ªã«ã‚ˆã‚Šãã®å€¤ãŒç•°ãªã‚‹ã€‚ä¸Šè¨˜è¿‘ä¼¼å¼ã¨ã¨ã‚‚ã«ã€ä¸‹è¨˜ã®Webãƒšãƒ¼ã‚¸ã«ã„ãã¤ã‹ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚‹ã€‚

* (https://ja.wikipedia.org/wiki/ãƒ•ãƒ¬ãƒãƒ«ã®å¼)
* (http://d.hatena.ne.jp/hanecci/20130525/p3)
* (https://yokotakenji.me/log/math/4501/)

ã“ã“ã§ã€ä¸Šè¿°ã®é¡é¢åå°„ãƒ™ã‚¯ãƒˆãƒ«è¨ˆç®—ã§è¿”ã•ã‚Œã‚‹ $\cos \theta$ ãŒå¿…è¦ãªã®ã ã€‚ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚$F_0$ (`Color`å‹)ã¨ $\cos \theta$ ãŒå¼•æ•°ã§ã‚ã‚‹ã€‚ã‚ã¨ã¯ä¸Šè¨˜ã®è¿‘ä¼¼å¼ãã®ã¾ã¾ã ã€‚

```haskell:Physics.hs
reflectionIndex :: Color -> Double -> Color
reflectionIndex (Color r g b) c =
  Color (r + (1-r) * c') (g + (1-g) * c') (b + (1-b) * c')
  where
    c' = (1.0 - c) ** 5.0
```
### -3. ãƒ•ã‚©ãƒˆãƒ³è¿½è·¡

é¡é¢åå°„ãƒ»å±ˆæŠ˜ãŒè¿½åŠ ã•ã‚ŒãŸã®ã§ã€ãƒ•ã‚©ãƒˆãƒ³è¿½è·¡ã‚‚ãã‚Œã«åˆã‚ã›ã¦ã„ã‚ã„ã‚æ‹¡å¼µã›ã­ã°ãªã‚‹ã¾ã„ã€‚ã“ã‚Œã¾ã§ã¯æ‹¡æ•£é¢ã ã‘ã ã£ãŸã®ã§ã€ãã®åå°„ç‡ã«ã‚ˆã£ã¦æ‹¡æ•£åå°„ã‹å¸åï¼ˆã¤ã¾ã‚Šè¿½è·¡çµ‚äº†ï¼‰ã—ã‹ãªã‹ã£ãŸãŒã€ãƒ•ã‚©ãƒˆãƒ³è¿½è·¡ã®æ¡ä»¶åˆ†å²ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¢—ãˆãŸã€‚

* æ‹¡æ•£åå°„ã‹é¡é¢åå°„ã‹å¸åã‹
* åå°„ã‹å±ˆæŠ˜ã‹

ã“ã®å ´åˆåˆ†ã‘ã‚’å‰è¿°ã®`Material`ã®å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’ä½¿ã£ã¦è¡¨ç¾ã—ã¦ã„ãã®ã ã€‚è§£ã‚Šæ˜“ã„ã‚ˆã†ã«ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã§è¡¨ãã†ã€‚ä¸‹å›³ã«å‰å›ï¼ˆæ‹¡æ•£åå°„é¢ã ã‘ï¼‰ã¨ä»Šå›ï¼ˆé¡é¢åå°„ãƒ»å±ˆæŠ˜è¿½åŠ ï¼‰ã®ãƒ•ãƒ­ãƒ¼ã‚’ç¤ºãã†ã€‚å‰å›ã®ãƒ•ãƒ­ãƒ¼ã¯ä»Šå›ã®ãƒ•ãƒ­ãƒ¼ã®ä¸€éƒ¨ã«ãªã£ã¦ã„ã‚‹(èµ¤ç‚¹ç·šã®éƒ¨åˆ†)ã®ã ã€‚

![11-flow.png](/images/raytracing-12/11-flow.png)

æ¬¡ã«ã‚³ãƒ¼ãƒ‰ã§æ¯”ã¹ã¦ã¿ã‚‹ã€‚å‰å›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```haskell:Tracer.hs
tracePhoton :: [Object] -> Int -> Photon -> IO [PhotonCache]
tracePhoton os l (wl, r) = do
  let is = calcIntersection r os
  if is == Nothing
    then return []
    else do
      let (p, n, m) = fromJust is
      i <- russianRoulette wl [reflectance m]
      pcs <- if i > 0
        then reflect p n os l wl
        else return []
      if (useClassicForDirect == False || l > 0) && diffuseness m > 0.0
        then return $ ((wl, initRay p (getDir r)) : pcs)
        else return pcs
```

ä¸­ç¨‹ã®`russianRoulette`ã«ã¦æ‹¡æ•£åå°„ç‡ã«ã‚ˆã‚‹åˆ†å²ã‚’ã—ã¦ã„ã‚‹ã€‚é–¢æ•°`reflect`ã¯æ‹¡æ•£åå°„ã—ã¦ã•ã‚‰ã«ãƒ•ã‚©ãƒˆãƒ³ã‚’è¿½è·¡ã™ã‚‹ã‚‚ã®ã ã€‚æœ€å¾Œã®`if`ã¯å‰å›å–ã‚Šå…¥ã‚ŒãŸç”»è³ªå‘ä¸Šç­–ã§ã‚ã‚‹ã€‚

ä¸€æ–¹ã€ä»Šå›æ‹¡å¼µã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```haskell:Tracer.hs

tracePhoton :: Bool -> Material -> [Object] -> Int -> Photon
            -> IO [PhotonCache]
tracePhoton _   _   _   10 _        = return []
tracePhoton !uc !m0 !os !l !(wl, r)
  | is == Nothing = return []
  | otherwise     = do
    let
      is' = fromJust is
      (p, _, m) = is'
      d = diffuseness m
    i <- russianRoulette [d]
    ref <- if i > 0
      then reflectDiff uc m0 os l wl is'
      else reflectSpec uc m0 os l (wl, r) is'
    if (uc == False || l > 0) && d > 0.0
      then return $ ((wl, initRay p $ getDir r) : ref)
      else return ref
  where
    is = calcIntersection r os

reflectDiff :: Bool -> Material -> [Object] -> Int -> Wavelength
            -> Intersection -> IO [PhotonCache]
reflectDiff uc m0 os l wl (p, n, m) = do
  i <- russianRoulette [selectWavelength wl $ reflectance m]
  if i > 0
    then do  -- diffuse reflection
      dr <- diffuseReflection n
      tracePhoton uc m0 os (l+1) $ (wl, initRay p dr)
    else return [] -- absorption

reflectSpec :: Bool -> Material -> [Object] -> Int -> Photon -> Intersection
            -> IO [PhotonCache]
reflectSpec uc m0 os l (wl, (_, ed)) (p, n, m) = do
  let
    f0 = selectWavelength wl $ specularRefl m
    (rdir, cos0) = specularReflection n ed
    f' = f0 + (1.0 - f0) * (1.0 - cos0) ** 5.0
  j <- russianRoulette [f']
  if j > 0
    then tracePhoton uc m0 os (l+1) (wl, initRay p rdir)
    else do
      if (selectWavelength wl $ ior m) == 0.0
        then return []   -- non transparency
        else reflectTrans uc m0 os l wl ed (p, n, m) cos0

reflectTrans :: Bool -> Material -> [Object] -> Int -> Wavelength -> Direction3
             -> Intersection -> Double -> IO [PhotonCache]
reflectTrans uc m0 os l wl ed (p, n, m) c0 = do
  let
    ior0 = selectWavelength wl $ ior m0
    ior1 = selectWavelength wl $ ior m
    (tdir, ior') = specularRefraction ior0 ior1 c0 ed n
    m0' = if tdir <.> n < 0.0 then m else m_air
  tracePhoton uc m0' os (l+1) (wl, initRay p tdir)
```

ä¸€è¦‹ã—ã¦å‰å›ã¨æ¯”ã¹ã¦ã‹ãªã‚Šè¤‡é›‘ã«ãªã£ãŸã®ãŒã‚ã‹ã‚‹ã ã‚ã†ã€‚`russianRoulette`ãŒã„ãã¤ã‹ä½¿ã‚ã‚Œã¦ãŠã‚Šã€ãã‚ŒãŒå„åˆ†å²ã«ãªã£ã¦ã„ã‚‹ã€‚`reflectDiff`, `reflectSpec`,`reflectTrans`ã¯ãã‚Œãã‚Œæ‹¡æ•£åå°„ã€é¡é¢åå°„ã€å±ˆæŠ˜ã®å ´åˆã®ãƒ•ã‚©ãƒˆãƒ³è¿½è·¡ã®å‡¦ç†ã ã€‚

å±ˆæŠ˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸã®ã§ã€æœ€åˆã®ç›®çš„ã ã£ãŸã€Œé›†å…‰æ¨¡æ§˜ã€ãŒå¾—ã‚‰ã‚Œã‚‹ã¯ãšã ï¼ã¨ã„ã†ã‚ã‘ã§ã€ã‚¬ãƒ©ã‚¹çƒã‚’é…ç½®ã—ã¦ãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ—ã‚’ç”Ÿæˆã—ã¦ã¿ã‚ˆã†ã€‚

![11-photonmap.png](/images/raytracing-12/11-photonmap.png)


å·¦ãŒä¸é€æ˜ãªæ‹¡æ•£åå°„é¢ã®çƒã®å ´åˆã€å³ãŒã‚¬ãƒ©ã‚¹çƒã ã€‚å·¦ã¯æ‹¡æ•£åå°„ã™ã‚‹ã®ã§çƒã®å½¢ã«ãƒ•ã‚©ãƒˆãƒ³ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¦ä¸‹ã«çƒã®å½±ãŒè¦‹ãˆã‚‹ã€‚ä¸€æ–¹å³ã¯ã‚¬ãƒ©ã‚¹çƒãªã®ã§çƒé¢çŠ¶ã«ãƒ•ã‚©ãƒˆãƒ³ã¯è¨˜éŒ²ã•ã‚Œãšã€ä»£ã‚ã‚Šã«çƒã®å½±ã®çœŸã‚“ä¸­ã«ãƒ•ã‚©ãƒˆãƒ³ãŒé›†ä¸­ã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã€‚ã“ã‚ŒãŒé›†å…‰æ¨¡æ§˜ã«ãªã‚‹ã®ã ï¼

### -4. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ–¹ç¨‹å¼(?)

ã•ã¦ã€ã„ã‚ˆã„ã‚ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®æ‹¡å¼µã ã€‚ãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ—ã‚’ã¿ã‚‹é™ã‚Šã€æƒ³å®šã—ãŸã¨ãŠã‚Šé›†å…‰æ¨¡æ§˜ãŒæã‘ãã†ãªæ°—ãŒã™ã‚‹ï¼

ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯ã€æ³¨ç›®ã™ã‚‹ç‚¹ï¼ˆè¦–ç·šãƒ¬ã‚¤ã¨ç‰©ä½“ã®äº¤ç‚¹ï¼‰ã«ã„ã‚ã„ã‚ãªæ–¹å‘ã‹ã‚‰å±Šãå…‰ã‚’é›†è¨ˆã—ã¦è¼åº¦ã¨ã—ã¦è¿”ã›ã°è‰¯ã„ã€‚ãŸã ã€è¨€è‘‰ã§ã¯ç°¡å˜ã ãŒã“ã‚ŒãŒãªã‹ãªã‹é›£ã—ã„ã€‚ç§ã¯ã„ã¾ã ã«è‰¯ã„ï¼ˆæ­£ç¢ºãª/ç‰©ç†çš„ã«æ­£ã—ã„/è¡¨ç¾åŠ›ã®é«˜ã„/â€¦ï¼‰é›†è¨ˆæ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„ã€‚ã¨ã¯ã„ãˆã‚ã‹ã‚‰ãªã„ãªã‚Šã«ä½œã‚‹ã—ã‹ãªã„ã®ã§ã€ä»Šå›æ¡ç”¨ã—ãŸé›†è¨ˆæ–¹æ³•ã‚’èª¬æ˜ã—ã‚ˆã†ã€‚

ã¾ãšã¯å‰å›ã¾ã§ã®å¼ã€‚

$$
L_o = L_e + d \frac{1}{\pi} (L_l + L_d)
$$

å„æ–‡å­—ã¯ãã‚Œãã‚Œä»¥ä¸‹ã‚’è¡¨ã™ã€‚

* $L_o$ : äº¤ç‚¹ã‹ã‚‰è¦–ç·šæ–¹å‘ã¸ã®è¼åº¦
* $L_e$ : ç‰©ä½“ã®ç™ºå…‰è¼åº¦
* $L_l$ : å…‰æºã‹ã‚‰ã®ç›´æ¥å…‰ï¼ˆãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ—ã‹ã‚‰æ¨å®šã™ã‚‹ã“ã¨ã‚‚å¯ï¼‰
* $L_d$ : é–“æ¥å…‰ï¼ˆãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ—ã‹ã‚‰æ¨å®šï¼‰
* $d$ : æ‹¡æ•£åº¦ï¼ˆ`Material`ä¸­ã®`diffuseness`ï¼‰

ã“ã‚Œã ã¨ãã‚“ãªã«è¤‡é›‘ã§ã¯ãªã„ã€‚è©²å½“ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®é€šã‚Šã€‚

```haskell:Tracer.hs
traceRay :: Int -> Double -> KT.KdTree Double PhotonInfo -> [Object]
         -> [Light] -> Ray -> IO Radiance
traceRay 10 _ _ _ _ _ = return radiance0
traceRay l pw pmap objs lgts r
  | is == Nothing = return radiance0
  | otherwise     = return (em + di + ii)
  where
    is = calcIntersection r objs
    (p, n, m) = fromJust is
    em = sr_half *> emittance m
    di = if useClassicForDirect
      then brdf m $ foldl (+) radiance0 $ map (getRadianceFromLight objs p n) lgts
      else radiance0
    ii = estimateRadiance pw pmap (p, n, m)
```

`em`ãŒ $L_e$ ã€`di`ãŒ $L_l$ ã€`ii`ãŒ $L_d$ã«ç›¸å½“ã™ã‚‹ã€‚ç›´æ¥å…‰ã¨é–“æ¥å…‰ã¯åˆ¥ã€…ã«BRDFã‚’é©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã¡ã‚‡ã£ã¨ã‚ã‹ã‚Šã«ãã„ãŒã€åŸºæœ¬çš„ã«ä¸Šè¨˜ã®å¼ã‚’ãã®ã¾ã¾é©ç”¨ã—ã¦ã„ã‚‹ã€‚

é¡é¢åå°„ã¨å±ˆæŠ˜ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã§ã€è¼åº¦è¨ˆç®—å¼ã¯æ¬¡ã®ã‚ˆã†ã«æ‹¡å¼µã—ãŸã€‚

$$
L_o = \frac{1}{2 \pi} L_e + d \frac{1}{\pi} (L_l + L_d) + (1 - d) \lbrace f L_s + (1 - m) \left((1 - f) L_t \right) \rbrace
$$

å„æ–‡å­—ã¯ãã‚Œãã‚Œä»¥ä¸‹ã‚’è¡¨ã™ã€‚

* $L_o$ : äº¤ç‚¹ã‹ã‚‰è¦–ç·šæ–¹å‘ã¸ã®è¼åº¦
* $L_e$ : ç‰©ä½“ã®ç™ºå…‰è¼åº¦
* $L_l$ : å…‰æºã‹ã‚‰ã®ç›´æ¥å…‰ï¼ˆãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ—ã‹ã‚‰æ¨å®šã™ã‚‹ã“ã¨ã‚‚å¯ï¼‰
* $L_d$ : é–“æ¥å…‰ï¼ˆãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ—ã‹ã‚‰æ¨å®šï¼‰
* $L_s$ : é¡é¢åå°„æ–¹å‘ã®è¼åº¦
* $L_t$ : å±ˆæŠ˜æ–¹å‘ã®è¼åº¦
* $d$ : æ‹¡æ•£åº¦ï¼ˆ`Material`ä¸­ã®`diffuseness`ï¼‰
* $f$ : äº¤ç‚¹ã®åå°„ç‡ (Schlickã®è¿‘ä¼¼å¼ã§è¨ˆç®—)
* $m$ : é‡‘å±æ€§ï¼ˆ`Material`ä¸­ã®`metalness`ï¼‰

ãªãŠã€$d, f, m$ ã¯ã„ãšã‚Œã‚‚ $0 \sim 1$ã®é–“ã®å€¤ã‚’ã¨ã‚‹ã€‚ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®é€šã‚Šã€‚(ãã†ã„ãˆã°ç‰©ä½“ã®ç™ºå…‰è¼åº¦ã« $\frac{1}{2 \pi}$ ã‚’æ›ã‘ã¦ã„ã‚‹ã®ã¯ãªãœã ã£ã‘ï¼Ÿ)

```haskell:Tracer.hs
traceRay :: Screen -> Material -> Int -> PhotonMap -> [Object] -> [Light] -> Ray -> IO Radiance
traceRay _    _   10 _     _     _     _  = return radiance0
traceRay !scr !m0 !l !pmap !objs !lgts !r
  | is == Nothing = return radiance0
  | otherwise     = do
    si <- if df == 1.0 || f == black
      then return radiance0
      else traceRay scr m0 (l+1) pmap objs lgts (initRay p rdir)
    ti <- if f' == black || ior1 == 0.0
      then return radiance0
      else do
        let
          ior0 = averageIor m0
          (tdir, ior') = specularRefraction ior0 ior1 cos0 (getDir r) n
          m0' = if tdir <.> n < 0.0 then m else m_air
        traceRay scr m0' (l+1) pmap objs lgts (initRay p tdir)
    return (sr_half    *> emittance m +
            df         *> brdf m (di + ii) +
            (1.0 - df) *> (f <**> si + (1.0 - mt) *> f' <**> ti))
  where
    is = calcIntersection r objs
    (p, n, m) = fromJust is
    di = if useClassicForDirect scr
      then foldl (+) radiance0 $ map (getRadianceFromLight objs p n) lgts
      else radiance0
    ii = estimateRadiance scr pmap (p, n, m)
    (rdir, cos0) = specularReflection n (getDir r)
    df = diffuseness m
    mt = metalness m
    f = reflectionIndex (specularRefl m) cos0
    f' = negateColor f                         -- this means '1 - f'
    ior1 = averageIor m
```

åå°„å±ˆæŠ˜æ–¹å‘ã«ãƒˆãƒ¬ãƒ¼ã‚¹ã™ã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®šãªã©å¤šå°‘ã‚„ã‚„ã“ã—ã„éƒ¨åˆ†ã¯ã‚ã‚‹ãŒã€åŸºæœ¬çš„ã«ã¯ä¸Šè¨˜å¼ã‚’ãã®ã¾ã¾å†ç¾ã—ã¦ã„ã‚‹ã€‚

ã•ã¦ã€ãã‚Œã§ã¯æ‹¡å¼µã—ãŸä»Šå›ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§æ•°ç¨®é¡ã®ç‰©è³ªã®çƒã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã¿ã‚ˆã†ã€‚

![11-balls.png](/images/raytracing-12/11-balls.png)

é¡é¢åå°„ãŒåŠ ã‚ã£ãŸã“ã¨ã§ã€ã‹ãªã‚Šè¡¨ç¾åŠ›ãŒé«˜ã¾ã£ãŸæ°—ãŒã™ã‚‹ã€‚ã¾ãŸã€ã‚¬ãƒ©ã‚¹çƒãŒè¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šå¿µé¡˜ã®é›†å…‰æ¨¡æ§˜ãŒå†ç¾ã§ããŸï¼

### -5. ãŠã¾ã‘ï¼šè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œ

å®Ÿã¯ã“ã‚Œã¾ã§ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ç”»åƒã®æƒ…å ±ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³æƒ…å ±ã¨ç‰©ä½“ã®æƒ…å ±ï¼‰ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ç›´æ›¸ãã—ã¦ã„ãŸã€‚æµçŸ³ã«ã‚·ãƒ¼ãƒ³ã‚’å¤‰æ›´ã™ã‚‹ãŸã³ã«ã‚½ãƒ¼ã‚¹ã‚’ä¿®æ­£ã—ã¦ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã®ã¯é¢å€’è‡­ãã€ã¾ãŸã•ã¾ã–ã¾ãªã‚·ãƒ¼ãƒ³ã‚’æç”»ã™ã‚‹ãŸã‚ã«ç”»åƒæƒ…å ±ã‚’æ®‹ã—ã¦ãŠããŸã„ã“ã¨ã‹ã‚‰ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«æ”¹ã‚ãŸã€‚

ã¾ãšã‚¹ã‚¯ãƒªãƒ¼ãƒ³æƒ…å ±ï¼ˆã‚«ãƒ¡ãƒ©ã®ä½ç½®ã‚„å‘ãã€è§£åƒåº¦ã€ã‚¢ãƒ³ãƒã‚¨ãƒªã‚¢ã‚¹è¦å¦ãªã©ï¼‰ã‚’è¡¨ã™ãƒ•ã‚¡ã‚¤ãƒ«(Screenãƒ•ã‚¡ã‚¤ãƒ«)ã®ä¾‹ã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ï¼ˆã‚¨ã‚»ï¼‰YAMLã¨ã—ãŸã€‚

```
nphoton       : 100000
xresolution   : 256
yresolution   : 256
antialias     : yes                # yes or no
samplephoton  : 100
useclassic    : yes                # yes or no
estimateradius: 0.3
ambient       : [ 0.001, 0.001, 0.001 ]
maxradiance   : 0.01
eyeposition   : [ 0.0, 2.0, -4.5 ]
targetposition: [ 0.0, 2.0, 0.0 ]
upperdirection: [ 0.0, 1.0, 0.0 ]
focus         : 2.7
photonfilter  : none               # cone, gauss
```

ã“ã¡ã‚‰ã¯å˜ç´”ãªå¤‰æ•°åã¨å€¤ã®çµ„ã ã‘ãªã®ã§ãªã‚“ã®ã“ã¨ã¯ãªã„ã€‚ä¸€æ–¹ã‚·ãƒ¼ãƒ³æƒ…å ±ï¼ˆç‰©ä½“ã®å½¢ã‚„é…ç½®ã€è‰²ãªã©ã‚’å®šç¾©ï¼‰ã®ä¾‹ã¨ã—ã¦ã‚¬ãƒ©ã‚¹çƒã®å ´åˆã‚’ç¤ºãã†ã€‚ã¡ã‚‡ã£ã¨é•·ã„ãŒå‹˜å¼é¡˜ã„ãŸã„ã€‚

```

light:
  - type     : parallelogram
    color    : [ 1.0, 1.0, 1.0 ]
    flux     : 5.0
    position : [ -0.5, 3.99, 2.5 ]
    dir1     : [ 1.0, 0.0, 0.0 ]
    dir2     : [ 0.0, 0.0, 1.0 ]

material:
  - type         : solid
    name         : mwall
    emittance    : [ 0.0, 0.0, 0.0 ]
    reflectance  : [ 0.5, 0.5, 0.5 ]
    transmittance: [ 0.0, 0.0, 0.0 ]
    specularrefl : [ 0.8, 0.8, 0.8 ]
    ior          : [ 0.0, 0.0, 0.0 ]
    diffuseness  : 1.0
    metalness    : 0.0
    smoothness   : 0.0
  - type         : solid
    name         : mwallr
    emittance:     [ 0.0, 0.0, 0.0 ]
    reflectance:   [ 0.4, 0.1, 0.1 ]
    transmittance: [ 0.0, 0.0, 0.0 ]
    specularrefl:  [ 0.0, 0.0, 0.0 ]
    ior:           [ 0.0, 0.0, 0.0 ]
    diffuseness:   1.0
    metalness:     0.0
    smoothness:    0.0
  - type         : solid
    name: mwallb
    emittance:     [ 0.0, 0.0, 0.0 ]
    reflectance:   [ 0.1, 0.1, 0.4 ]
    transmittance: [ 0.0, 0.0, 0.0 ]
    specularrefl:  [ 0.0, 0.0, 0.0 ]
    ior:           [ 0.0, 0.0, 0.0 ]
    diffuseness:   1.0
    metalness:     0.0
    smoothness:    0.0
  - type         : solid
    name: mparal
    emittance:     [ 0.7958, 0.7958, 0.7958 ]
    reflectance:   [ 0.0, 0.0, 0.0 ]
    transmittance: [ 0.0, 0.0, 0.0 ]
    specularrefl:  [ 0.0, 0.0, 0.0 ]
    ior:           [ 0.0, 0.0, 0.0 ]
    diffuseness:   0.0
    metalness:     0.0
    smoothness:    0.0
  - type         : solid
    name         : glass
    emittance:     [ 0.0, 0.0, 0.0 ]
    reflectance:   [ 0.0, 0.0, 0.0 ]
    transmittance: [ 0.0, 0.0, 0.0 ]
    specularrefl:  [ 0.08, 0.08, 0.08 ]
    ior:           [ 1.5, 1.5, 1.5 ]
    diffuseness:   0.0
    metalness:     0.0
    smoothness:    0.0

vertex:
  - cl01 : [ -0.5, 3.99, 2.5 ]
  - cl02 : [ 0.5, 3.99, 2.5 ]
  - cl03 : [ -0.5, 3.99, 3.5 ]

object:
  - type    : plain
    name    : flooring
    normal  : [ 0.0, 1.0, 0.0 ]
    position: [ 0.0, 0.0, 0.0 ]
    material: mwall
  - type    : plain
    name    : ceiling
    normal  : [ 0.0, -1.0, 0.0 ]
    position: [ 0.0, 4.0, 0.0 ]
    material: mwall
  - type    : plain
    name    : rsidewall
    normal  : [ -1.0, 0.0, 0.0 ]
    position: [ 2.0, 0.0, 0.0 ]
    material: mwallb
  - type    : plain
    name    : lsidewall
    normal  : [ 1.0, 0.0, 0.0 ]
    position: [ -2.0, 0.0, 0.0 ]
    material: mwallr
  - type    : plain
    name    : backwall
    normal  : [ 0.0, 0.0, 1.0 ]
    position: [ 0.0, 0.0, -6.0 ]
    material: mwall
  - type    : plain
    name    : frontwall
    normal  : [ 0.0, 0.0, -1.0 ]
    position: [ 0.0, 0.0, 5.0 ]
    material: mwall
  - type    : sphere
    name    : ball_glass
    center  : [ 0.0, 0.8, 3.0 ]
    radius  : 0.8
    material: glass
  - type    : parallelogram
    name    : ceiling_light
    pos1    : cl01
    pos2    : cl02
    pos3    : cl03
    material: mparal
```

ä»¥å‰ã€CPUå›ã§ä½¿ã£ãŸ`Parsec`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã“ã“ã§ã‚‚ä½¿ã£ã¦ã¿ãŸã€‚CPUå›ã§ãªã‚“ã¨ãªããƒ‘ãƒ¼ã‚µã®æ„Ÿè§¦ã‚’ã¤ã‹ã‚“ã§ã„ãŸã®ã§ã‚ã¾ã‚Šãƒãƒã‚‹ã“ã¨ãªãå®Ÿè£…ã§ããŸã€‚`Parsec`ã‚’ä½¿ã£ãŸãƒ‘ãƒ¼ã‚µä½œã‚Šã¯ã€ä¹—ã£ã¦ãã‚‹ã¨ã©ã‚“ã©ã‚“ãƒ‘ãƒ¼ã‚µã‚’é«˜åº¦åŒ–ã—ã¦ã„ã‘ã‚‹ã®ã§æ¥½ã¡ã‚“ã ã€‚å…ˆäººã«æ„Ÿè¬ã€‚

å®Ÿè¡Œæ–¹æ³•ã¯æ¬¡ã®é€šã‚Š(ã‚¬ãƒ©ã‚¹çƒã®ä¾‹ã€ex-11.6)ã€‚

```shell
$ cabal build
$ dist/build/pm/pm example/screen0.scr example/ex-11.6.scene | dist/build/rt/rt example/screen0.scr example/ex-11.6.scene | convert - ~/tmp/ex-11.6.png
```

ã“ã‚Œã§ `~/tmp/ex-11.6.png`ã¨ã„ã†ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºæ¥ä¸ŠãŒã‚‹ã€‚
ãŸã ã€åŒã˜æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ—ä½œæˆ(`pm`)ã¨ãƒ¬ã‚¤ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°(`rt`)ã§
ç¹°ã‚Šè¿”ã™ã®ã¯é¢å€’ã ã—ç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›(ImageMagickã®`convert`ã‚’ä½¿ç”¨)ã‚‚
æ¯å›æ›¸ãã®ã¯é‚ªé­”è‡­ã„ã®ã§ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

```shell
$ util/drv.sh example/screen0.scr example/ex-11.6.scene ~/tmp/ex-11.6.png
```

## 2. ä½œä¾‹

ä¸Šè¨˜ã®ä»–ã«ã‚‚å°‘ã—ä½œä¾‹ã‚’ç¤ºãã†ã€‚

![11-examples.png](/images/raytracing-12/11-examples.png)

å·¦ä¸Šã¯å¤©äº•ã‹ã‚‰ã®æ—¥å…‰ã‚’é¡é¢ä¸‰è§’æŸ±ã§å£ã«åå°„ã—ã¦ã„ã‚‹å›³ã€å³ä¸Šã¯ä¾‹ã®ãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°æœ¬ã§ãªã‚“ã©ã‚‚å‡ºã¦ãã‚‹å›³ã€‚ã“ã‚ŒãŒã‚„ã‚ŠãŸã‹ã£ãŸï¼ä¸‹ã®äºŒã¤ã¯çƒä»¥å¤–ã®å½¢çŠ¶ã‚’ã‚¬ãƒ©ã‚¹ã§ä½œã£ã¦ã¿ãŸã‚‚ã®ã€‚æœ€å¾Œã«é›†å…‰æ¨¡æ§˜ã®é¢ç™½ã„ä¾‹ã¨ã—ã¦å…‰ã®æ³¢é•·ã«ã‚ˆã‚Šå±ˆæŠ˜ç‡ãŒç•°ãªã‚‹ã‚¬ãƒ©ã‚¹çƒã®ç”»åƒã€‚å±ˆæŠ˜ç‡ã®é•ã„ã«ã‚ˆã‚Šãƒ—ãƒªã‚ºãƒ ã®ã‚ˆã†ã«è™¹è‰²ï¼ˆï¼Ÿï¼‰ã«åˆ†ã‹ã‚ŒãŸé›†å…‰æ¨¡æ§˜ã«ãªã‚‹ã€‚ãŸã ã—ã€æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯RGBä¸‰ç¨®é¡ã®ãƒ•ã‚©ãƒˆãƒ³ã—ã‹ä½¿ã£ã¦ã„ãªã„ãŸã‚ã€é’ã‚ˆã‚ŠçŸ­æ³¢é•·ã®ç´«ãŒè¡¨ç¾ã§ããªã„ã€‚ãã“ã¾ã§ã‚„ã‚‹ã«ã¯RGBã«ç´«ã‚’è¿½åŠ ã—ã¦ãƒ•ã‚©ãƒˆãƒ³ã®ç¨®é¡ã‚’å¢—ã‚„ã—ã¦è¿½è·¡ã—ãªã„ã¨ã ã‚ã ã‚ã†ã€‚ã¡ã‚‡ã£ã¨é¢å€’ãªã®ã§å®¿é¡Œã«ã—ã¦ãŠã“ã†ã€‚

![ex-11.6-2.png](/images/raytracing-12/ex-11.6-2.png)



## 3. ã¾ã¨ã‚

ä»Šå›ã§ã‚„ã£ã¨é›†å…‰æ¨¡æ§˜ã¾ã§ãŸã©ã‚Šç€ã„ãŸã€‚æœ€åˆHaskellã§ãƒ•ã‚©ãƒˆãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ¬ã‚¤ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å–ã‚Šæ›ã‹ã£ãŸé ƒã¯æ­£ç›´è‡ªä¿¡ãŒãªã‹ã£ãŸãŒæ•°å¹´ãŒã‹ã‚Šã§ã“ã“ã¾ã§ããŸã€‚ã‚„ã‚Œã‚„ã‚Œã€‚ã¾ã‚ã€ãƒ¬ã‚¤ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ»ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã¯ã¾ã ã¾ã ã‚„ã‚‹ã“ã¨ã¯å¤§é‡ã«ã‚ã‚‹ãŒã€ä¸€æ—¦ã“ã“ã¾ã§ã€‚æ°—ãŒå‘ã„ãŸã‚‰æ‹¡å¼µã—ã‚ˆã†ã¨æ€ã†ã€‚

â€» ä»Šå›åˆ†ã®ã‚½ãƒ¼ã‚¹ã¯[ã“ã¡ã‚‰](https://github.com/eijian/raytracer/tree/version-2.5.3.0)ã€‚
