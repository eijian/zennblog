---
title: "ãƒ¬ã‚¤ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°(14): å…‰æ²¢é¢ã«ãƒˆãƒ©ã‚¤"
emoji: "ğŸ’¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Haskell", "RayTracing", "PhotonMapping"]
published: true
---

ã“ã‚Œã¾ã§ã¯ç‰©ä½“è¡¨é¢ã§ã®åå°„ã¨ã—ã¦å®Œå…¨æ‹¡æ•£åå°„ã¨å®Œå…¨é¡é¢åå°„ã®ã¿æ‰±ã£ã¦ããŸã€‚ãŸã ç¾å®Ÿä¸–ç•Œã¯ã»ã¨ã‚“ã©ãŒå…‰æ²¢ã®ã‚ã‚‹è¡¨é¢ï¼ˆå…‰æ²¢é¢ã¨ã™ã‚‹ï¼‰ãªã®ã§ã€ãƒªã‚¢ãƒ«ãªç”»åƒã‚’ç”Ÿæˆã™ã‚‹ã«ã¯å…‰æ²¢é¢ã®ã‚µãƒãƒ¼ãƒˆãŒå¿…é ˆã§ã‚ã‚‹ã€‚ã¨ãã«ã¼ã‚„ã‘ãŸãƒã‚¤ãƒ©ã‚¤ãƒˆã¯3DCGã®é†é†å‘³(?)ã§ã‚ã‚‹ã€‚ä»Šå›ã¯ãã‚Œã‚’å®Ÿè£…ã—ã¦ã¿ã‚‹ã€‚

## 0. Progressive Photon Mappingæ³•ã«ç‰¹åŒ–

ãã®å‰ã«ãƒ»ãƒ»ãƒ»

å‰å›è¨˜äº‹ã§ã¯ã€å¾“æ¥ã®Photon Mappingæ³•ã‚’ç”¨ã„ãŸãƒ¬ã‚¤ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å¯¾ã—ã€Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€Progressive Photon Mappingæ³•ï¼ˆä»¥ä¸‹PPMæ³•ï¼‰ã«ã‚ˆã‚‹ç”»è³ªå‘ä¸Šã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã€‚ã—ã‹ã—ä½œã£ã¦ã¿ã‚‹ã¨ã€ã“ã®PPMæ³•ã¯ã“ã‚Œã¾ã§ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«æ¯”ã¹ã€ã‹ãªã‚Šå®¹æ˜“ã«è¡¨ç¾åŠ›ã®å‘ä¸ŠãŒå¯èƒ½ã«ãªã‚‹ã¨ã‚ã‹ã£ãŸã€‚ãŸã¨ãˆã°ã€Œã¡ã‚ƒã‚“ã¨ã—ãŸã‚¢ãƒ³ãƒã‚¨ãƒªã‚¢ã‚·ãƒ³ã‚°ã€ã‚„ä»Šå›å–ã‚Šçµ„ã‚€å…‰æ²¢é¢ãªã©ã§ã‚ã‚‹ã€‚

é€†ã«ã€PPMã§ãªã„ã¨å…‰æ²¢é¢ãªã©ã®åŠ¹æœã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã§ããªã„ã“ã¨ã‹ã‚‰ã€ä»Šå¾Œã¯PPMã‚’ä¸»ä½“ã¨ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€PPMã‚’ä½¿ã†ã‹ã©ã†ã‹ã¨ã„ã£ãŸãƒ•ãƒ©ã‚°ã‚„å ´åˆã‚ã‘ã¯æ’é™¤ã—ã€PPMã«ç‰¹åŒ–ã—ãŸå®Ÿè£…ã«å¤‰æ›´ã™ã‚‹ã€‚çµæœã¨ã—ã¦ã€å®Ÿè£…ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãŒã‚‰PPMã®ç¹°ã‚Šè¿”ã—å›æ•°ã‚’å¢—ã‚„ã™ã»ã©é«˜å“è³ªãªç”»åƒãŒç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨æœŸå¾…ã™ã‚‹ã€‚

### 1. å…‰æ²¢é¢ã®è€ƒãˆæ–¹

å…‰æ²¢é¢ã¯å®Œå…¨æ‹¡æ•£é¢ã¨å®Œå…¨é¡é¢ã®ä¸­é–“ã¨ãªã‚‹è¡¨é¢çŠ¶æ…‹ã§ã‚ã‚‹ã€‚

![å›³1.1.png](/images/raytracing-14/fig1.1.png)


å…‰å­ãŒç‰©ä½“è¡¨é¢ã«å½“ãŸã£ãŸæ™‚ã«ã€å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆæ‹¡æ•£åå°„ï¼‰ã§ã‚‚å®Œå…¨ã«ä¸€æ–¹å‘ï¼ˆé¡é¢åå°„ï¼‰ã§ã‚‚ãªãã€ã‚ã‚‹ç¨‹åº¦ã®ç¢ºç‡ã§é¡é¢åå°„æ–¹å‘ã®å‘¨å›²ã«åˆ†æ®‹ã—ã¦åå°„ã™ã‚‹ã€‚ã©ã®ç¨‹åº¦ã®ç¢ºç‡ã§ã©ã‚Œã»ã©åˆ†æ•£ã™ã‚‹ã‹ã¯è¡¨é¢ã®ç²—ã•ï¼ˆ$roughness$ï¼‰ã§è¡¨ã™ã€‚ã“ã‚ŒãŒ0ãªã‚‰å®Œå…¨ã«å¹³æ»‘ã§é¡é¢åå°„ã€1ãªã‚‰ã©ã®æ–¹å‘ï¼ˆäº¤ç‚¹ã‹ã‚‰åŠçƒä¸Šã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ï¼‰ã¸ã‚‚åå°„ã—ã†ã‚‹ã¨ã™ã‚‹ï¼ˆãŸã å¾Œè¿°ã®é€šã‚Šã€å®Œå…¨ãªæ‹¡æ•£åå°„ã¯è«¦ã‚ãŸï¼‰ã€‚

ã“ã“ã§ã€Œãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã«ã¤ã„ã¦è¨€åŠã—ã¦ãŠããŸã„ã€‚æ˜”ã‹ã‚‰ã‚ã‚‹ãƒ™ã‚¿ãª3DCGç”»åƒã§ã¯ã€åºŠå¹³é¢ä¸Šã«çƒä½“ãŒç½®ã‹ã‚Œã€ä¾‹ãˆã°çƒã®å³ä¸Šãã‚‰ã„ã«æ˜ã‚‹ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒã¼ã‚“ã‚„ã‚Šã¨ã—ãŸç™½ã„å††ã§è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒç”»åƒã®ãƒªã‚¢ãƒ«ã•ã‚’ãã£ã¨å¼•ãä¸Šã’ã‚‹ã€‚æ˜”ãªãŒã‚‰ã®æ‰‹æ³•ã§ã¯ã“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¦–ç·šã€å…‰æºæ–¹å‘ãªã©ã‹ã‚‰è¨ˆç®—ã§æ“¬ä¼¼çš„ã«æ±‚ã‚ã¦ã„ãŸã‚ã‘ã ã€‚ã—ã‹ã—å®Ÿéš›ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ã€Œå…‰æºã®æ˜ ã‚Šè¾¼ã¿ã€ã§ã‚ã‚‹ã€‚å‘¨ã‚Šã®ç‰©ä½“ãŒåå°„ã—ã¦æ˜ ã‚Šè¾¼ã‚€ã®ã¨ãªã‚“ã‚‰å¤‰ã‚ã‚‰ãªã„ã€‚ã‚†ãˆã«ã“ã‚Œã¾ã§ã®è¨˜äº‹ã®ä½œä¾‹ã§ã¯çƒã®ä¸Šéƒ¨ã«å››è§’ã„ã‚¨ãƒªã‚¢ãƒ©ã‚¤ãƒˆãŒãã®ã¾ã¾æ˜ ã‚Šè¾¼ã‚“ã§ã„ã‚‹ï¼ˆå®Œå…¨é¡é¢åå°„ã ã‹ã‚‰ï¼‰ã€‚

![å›³1.2.jpg](/images/raytracing-14/img1.2.jpg)

ã§ã¯ã¼ã‚“ã‚„ã‚Šã—ãŸãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ã©ã†ã‚„ã£ã¦ã§ãã‚‹ã®ã‹ã¨ã„ã†ã¨ã€ç‰©ä½“è¡¨é¢ãŒã–ã‚‰ã¤ã„ã¦ã„ã‚‹ãŸã‚ã«ã€è¡¨é¢ã®å¾®å°ãªã¨ã“ã‚ã§ã¯ã€ã‚ã‚‹éƒ¨åˆ†ã¯å…‰æºãŒæ˜ ã‚Šè¾¼ã¿ã€ã‚ã‚‹éƒ¨åˆ†ã¯æ˜ ã‚Šè¾¼ã¾ãªã„ã¨ã„ã£ãŸã“ã¨ãŒèµ·ã“ã£ã¦ã„ã¦ã€ãã‚Œã‚‰ã‚’ç·åˆã™ã‚‹ã¨å…‰æºãŒã¼ã‚“ã‚„ã‚Šæ˜ ã‚‹ã“ã¨ã«ãªã‚‹ã‹ã‚‰ã ã€‚

ã§ã‚ã‚Œã°ã€æ“¬ä¼¼çš„ã«è¨ˆç®—ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã€Œä½œã‚‹ã€ã®ã§ã¯ãªãã€å…‰æºã®æ˜ ã‚Šè¾¼ã¿ã¨ã„ã†å˜ç´”ãªå‡¦ç†ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚PPMã‚’ä½¿ãˆã°ãã‚ŒãŒã†ã¾ãã§ããã†ã ã€‚

### 2. å¾®å°å¹³é¢ã®æ³•ç·š

å…‰æ²¢é¢ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€å…‰å­/è¦–ç·šãŒåå°„ã™ã‚‹æ–¹å‘ã‚’ $roughness$ ã«å¿œã˜ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ãã®æ–¹æ³•ã«ã¯å¤§ããä¸‹ã®ï¼’ç¨®é¡ãŒã‚ã‚‹ï¼ˆã¨æ€ã†ï¼‰ã€‚

1. äº¤ç‚¹ã‹ã‚‰é¡é¢åå°„æ–¹å‘ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä¸­å¿ƒã¨ã—ã¦ãã®å‘¨å›²ã«åºƒãŒã£ãŸæ–¹å‘ã‚’ç”Ÿæˆã™ã‚‹
2. äº¤ç‚¹ã®å¾®å°å¹³é¢æ³•ç·šã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ã€ãã‚Œã‚’åŸºã«åå°„æ–¹å‘ã‚’ç®—å‡ºã™ã‚‹

ä»Šå›ã¯2ã§å®Ÿè£…ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚ç†ç”±ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

* 1ã®å ´åˆãƒ©ãƒ³ãƒ€ãƒ ã«æ–¹å‘ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€å…¥å°„æ–¹å‘å¯„ã‚Šã®æ–¹å‘ãŒç”Ÿæˆã§ããªã„ï¼ˆã‚ã‘ã§ã¯ãªã„ãŒé¢å€’ã«æ€ã£ãŸï¼‰(å›³2.2-a)
* å¾®å°å¹³é¢æ³•ç·šã‚’ä½¿ãˆã°ã€åå°„ãƒ™ã‚¯ãƒˆãƒ«ã ã‘ã§ãªãå±ˆæŠ˜ãƒ™ã‚¯ãƒˆãƒ«ã‚‚ä½œã‚Šå‡ºã›ã‚‹ï¼ˆå›³2.2-bï¼‰
* ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚¡ã‚»ãƒƒãƒˆç†è«–ã¨ã®ç›¸æ€§ãŒã„ã„ã®ã§ã¯ãªã„ã‹ï¼ˆã¨å‹æ‰‹ã«æ¨æ¸¬ï¼‰

![å›³2.1.png](/images/raytracing-14/fig2.1.png)

ã§ã¯å®Ÿéš›ã®ä½œã‚Šæ–¹ã ã€‚

1. ã¾ãšäº¤ç‚¹ã®æ³•ç·šãƒ™ã‚¯ãƒˆãƒ« $n$ ã¨å…‰å­/è¦–ç·šã®å…¥å°„ãƒ™ã‚¯ãƒˆãƒ« $e$ ã‹ã‚‰ã€ $n$ ã¨ç›´è¡Œã™ã‚‹äº¤ç‚¹å¹³é¢ä¸Šã®ãƒ™ã‚¯ãƒˆãƒ« $u$,$v$ ã‚’å¤–ç©ã‚’ä½¿ã£ã¦æ±‚ã‚ã‚‹ã€‚ï¼ˆå›³2.3ï¼‰

![å›³2.3.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/69542/98e47919-4735-f9a7-7440-e8554fa73241.png)
2. æ¬¡ã«ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½œã‚‹ãŸã‚ã€ï¼’ã¤ã®ä¸€æ§˜ä¹±æ•° $\xi_1 [0,1]$ , $\xi_2 [0,1]$ ã‚’ç”Ÿæˆã—ã¦ä¸‹å¼ã‚’ç”¨ã„ã¦ä¸Šè¨˜ç›´è¡Œãƒ™ã‚¯ãƒˆãƒ«ã®é•·ã•ã‚’è¨ˆç®—ã™ã‚‹($x$ , $y$ , $z$ ã¨ã™ã‚‹)ã€‚
(å‚è€ƒ: [Realistic Image Synthesis - BRDFs and Direct Lighting -](https://graphics.cg.uni-saarland.de/courses/ris-2018/slides/09_BRDF_LightSampling.pdf) ã®p.5)

  $$
    \qquad x = \cos{(2\pi\xi_1})\sqrt{(1-\xi_2^{\frac{2}{m+1}})} \\
  $$

  $$
    \qquad y = \xi_2^{\frac{1}{m+1}} \\
  $$

  $$
    \qquad z = \sin{(2\pi\xi_1})\sqrt{(1-\xi_2^{\frac{2}{m+1}})}
  $$

3. ç›´è¡Œãƒ™ã‚¯ãƒˆãƒ«ã¨å„ä¿‚æ•°ã‹ã‚‰å¾®å°å¹³é¢ã®æ³•ç·šãƒ™ã‚¯ãƒˆãƒ« $n'$ ã‚’æ±‚ã‚ã‚‹ã€‚

ã“ã‚Œã§æ³•ç·šãƒ™ã‚¯ãƒˆãƒ« $n'$ ã‚’ç”Ÿæˆã§ããŸã€‚ã¨ã“ã‚ã§ç²—ã• $roughness$ ã¯ã©ã“ã¸è¡Œã£ãŸã®ã ã‚ã†ã‹ï¼Ÿ $roughness$ ã«å¿œã˜ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã•ã‚Œã‚‹$n'$ ã®æ‹¡ãŒã‚Šå…·åˆãŒå¤‰ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ã§ã¯ãªã‹ã£ãŸã‹ï¼Ÿä¸Šè¨˜ã®é•·ã•ã‚’è¨ˆç®—ã™ã‚‹å¼ã«å‡ºã¦ãã‚‹ $m$ ã«æ³¨ç›®ã—ã¦ã»ã—ã„ã€‚ã“ã® $m$ ã‚’ $0$ ã‹ã‚‰ $\infty$ ã¾ã§å¤‰åŒ–ã•ã›ã‚‹ã“ã¨ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã‚‹æ–¹å‘ã®æ‹¡ãŒã‚Šå…·åˆã‚’èª¿æ•´ã§ãã‚‹ã€‚$m$ ãŒ$0$ãªã‚‰ä¸€æ§˜ã«æ‹¡æ•£ï¼ˆå®Œå…¨æ‹¡æ•£é¢ï¼‰ã€ $\infty$ ãªã‚‰ $y$ æˆåˆ†ã¯å¸¸ã« $1$ ï¼ˆå®Œå…¨é¡é¢ï¼‰ã¨ãªã‚‹ã®ã§ã€$roughness [0,1]$ ã‹ã‚‰ $m$ ã‚’ä½œã‚Šå‡ºã›ã‚Œã°ã‚ˆã„ã€‚

$$
  \qquad roughness = 0 \rightarrow m = \infty \\
$$

$$
  \qquad roughness = 1 \rightarrow m = 0
$$

ã•ã¦å•é¡Œã¯ã€ä¸Šè¨˜ã®ã‚ˆã†ãªå¤‰æ›ãŒã§ãã€ã‹ã¤$roughness$ã®å¤‰åŒ–ã«ã§ãã‚‹ã ã‘ãƒªãƒ‹ã‚¢=è¦‹ãŸç›®ã«ãªã ã‚‰ã‹ãªå¤‰åŒ–ã€ã¨ãªã‚‹ã‚ˆã†ãªé–¢æ•°ã‚’ã©ã†é¸ã¶ã‹ã§ã‚ã‚‹ã€‚ã„ã‚ã„ã‚è©¦è¡ŒéŒ¯èª¤ã—ãŸçµæœã€ä»Šå›ã¯ä¸‹ã®å¼ã§ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

$$
  \qquad m = (10^6)^{(1 - \sqrt{roughness})}
$$

ã“ã®å¼ã®æ„å›³ã¯æ¬¡ã®é€šã‚Šã€‚

* $roughness$ã®å¤‰åŒ–ã«å¯¾ã— $m$ ã®å¤‰åŒ–ãŒé€†ï¼ˆå¢—ãˆã‚‹ã¨æ¸›ã‚‹ï¼‰ãªã®ã§ã€æƒãˆã‚‹ãŸã‚ã«$1-roughness$ ã®ã‚ˆã†ãªå½¢ã«ã—ãŸãŒã€å¾®èª¿æ•´ã®ãŸã‚ $\sqrt{roughness}$ ã‚’ä½¿ã£ãŸã€‚
* $10^6$ã¨ã—ãŸã®ã¯ã€Œè¦‹ãŸç›®ã«ãªã ã‚‰ã‹ãªå¤‰åŒ–ã€ã¨ãªã‚‹ã‚ˆã†ãªå†ªæŒ‡æ•°ã‚’è©¦ã—ãŸçµæœã€‚å¥½ã¿ã€‚
* $\infty$ ã¯ç„¡ç†ã ãŒã€$1-\sqrt{roughness}$ãŒ$1$ãªã‚‰éå¸¸ã«å¤§ããªæ•°å­—ã«ãªã£ã¦ã»ã—ã„ã®ã§æŒ‡æ•°é–¢æ•°ã‚’ä½¿ã£ãŸã€‚

ãŸã ã—ã“ã®å¼ã§ã¯ã©ã‚“ãª$roughness [0,1]$ ã§ã‚‚ $m=0$ã«ã¯ã§ããªã„ã®ã§ã€å®Œå…¨æ‹¡æ•£åå°„ã¯è¡¨ç¾ã§ããªã„ãŒã€‚

ã“ã‚Œã§å¾®å°å¹³é¢æ³•ç·šï¼ˆ$n'$ï¼‰ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã‚ã¨ã¯äº¤ç‚¹æ³•ç·š $n$ ã®ä»£ã‚ã‚Šã«$n'$ ã‚’ä½¿ã£ã¦å…‰ç·šè¿½è·¡ã™ã‚‹ã ã‘ã§è‰¯ã„ã€‚ãªãŠã€ã“ã®ã‚ˆã†ã«ãƒ©ãƒ³ãƒ€ãƒ ã«æ³•ç·šã‚’é¸ã‚“ã§ã—ã¾ã†ã¨ãã®æ–¹å‘ã‹ã‚‰ãã‚‹å…‰ã—ã‹ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ä½¿ãˆãªã„ï¼ˆã‚‚ã£ã¨ã‚ã‚‰ã‚†ã‚‹æ–¹å‘ã‹ã‚‰ãã‚‹å…‰ã‚’é›†ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã«ï¼‰ã¨æ€ã†ãŒã€ãã“ã§PPMãŒå¨åŠ›ã‚’ç™ºæ®ã™ã‚‹ã‚ã‘ã ã€‚ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°ã‚’1000ã¨ã™ã‚Œã°ã€ãƒ©ãƒ³ãƒ€ãƒ ã«1000ç¨®é¡ã®æ–¹å‘ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã—ãŸçµæœã‚’ç·åˆã§ãã‚‹ã€‚ãƒ‘ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®ã‚ˆã†ã«äº¤ç‚¹ã§ãƒ©ãƒ³ãƒ€ãƒ ãªå¤šæ•°ã®ãƒ¬ã‚¤ã‚’ç”Ÿæˆã—ã¦è¿½è·¡ã€ã•ã‚‰ã«å…ˆã®äº¤ç‚¹ã§ãƒ©ãƒ³ãƒ€ãƒ ãªå¤šæ•°ã®ãƒ¬ã‚¤ã‚’ç”Ÿæˆã—ã¦ãƒ»ãƒ»ãƒ»ã¨ã™ã‚‹ã¨è¿½è·¡ã™ã‚‹ãƒ¬ã‚¤ãŒæŒ‡æ•°é–¢æ•°çš„ã«çˆ†ç™ºã™ã‚‹ãŒã€PPMã§ã¯ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°ã§æŠ‘ãˆã‚‰ã‚Œã‚‹ã®ã§å‡¦ç†è² è·ã‚’ä½ãã§ãã‚‹ï¼ˆãƒã‚ºï¼‰ã€‚æœ€åˆã®ãƒ¬ã‚¤ã€äº¤ç‚¹ã§ã®åå°„æ–¹å‘ã®ãƒ¬ã‚¤ã‚’ç¢ºç‡ã§ä¸€ã¤é¸ã‚“ã§ç”Ÿæˆã—ã¦ã„ã‚‹ã®ã§ã€ãŸã¶ã‚“
çµ±è¨ˆå­¦çš„ã«ã‚‚ã‚ˆã„çµæœãŒå¾—ã‚‰ã‚Œã‚‹ã€ã¨æœŸå¾…ã—ã‚ˆã†ã€‚

### 3. å®Ÿè£…ã¨ä½œä¾‹

ã¾ãšç‰©ä½“ã®æè³ªã‚’è¡¨ã™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«$roughness$ã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹$m$ï¼ˆã‚’å«ã‚ãŸå†ªæŒ‡æ•°ï¼‰ã‚’`powerGlossy`ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã€‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ãŸã³ã«ã“ã®è¨ˆç®—ã‚’è¡Œã†ã®ã‚’é¿ã‘ã‚‹ãŸã‚ã§ã‚ã‚‹ã€‚ã“ã®å†ªæŒ‡æ•°ã‚’è¨ˆç®—ã—ã¦ã„ã‚‹é–¢æ•°ãŒ`densityPower`ã§ã‚ã‚‹ã€‚

```haskell:src/Ray/Surface.hs
densityPower :: Double -> Double
densityPower rough = 1.0 / (10.0 ** pw + 1.0)
  where
    pw = 6.0 * (1.0 - sqrt rough)
```

æ¬¡ã«ã€ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆã™ã‚‹`distributedNormal`ã§ã‚ã‚‹ã€‚ï¼’ã¤ã®ä¹±æ•°`xi1`, `xi2`ã‚’ç”Ÿæˆã—ãŸã‚ã¨ã€ä¸Šè¨˜å¼ã«åŸºã¥ãä¿‚æ•°`x`,`y`,`z`ã‚’æ±‚ã‚ã€æœ€å¾Œã«ã¾ã¨ã‚ã¦æ³•ç·šãƒ™ã‚¯ãƒˆãƒ«`nvec'`ã«ã—ã¦ã„ã‚‹ã€‚

```haskell:src/Ray/Physics.hs
distributedNormal :: Direction3 -> Double -> IO Direction3
distributedNormal nvec pow = do
  xi1 <- MT.randomIO :: IO Double    -- horizontal
  xi2 <- MT.randomIO :: IO Double    -- virtical
  let
    phi = 2.0 * pi * xi2
    uvec0 = normalize $ nvec <*> (Vector3 0.00424 1.0 0.00764)
    uvec = case uvec0 of
      Just v  -> v
      Nothing -> fromJust $ normalize $ nvec <*> (Vector3 1.0 0.00424 0.00764)
    vvec = uvec <*> nvec
    xi1' = xi1 ** pow
    rt = sqrt (1.0 - xi1' * xi1')

    x = cos(phi) * rt
    y = xi1'
    z = sin(phi) * rt

    nvec' = x *> uvec + y *> nvec + z *> vvec    -- n'ã®ç”Ÿæˆ
  case normalize nvec' of
    Just v  -> return v
    Nothing -> return ex3    
```

ã‚ã¨ã¯ã“ã‚Œã¾ã§å˜ç´”ã«äº¤ç‚¹æ³•ç·šã‚’ä½¿ã£ã¦ã„ãŸã¨ã“ã‚ã‚’ç½®ãæ›ãˆã¦ã‚„ã‚Œã°è‰¯ã„ã€‚

```haskell:src/Tracer.hs
traceRay :: Screen -> Bool -> V.Vector Object -> V.Vector Light -> Int
  -> PhotonMap -> Double -> Material -> Ray -> IO Radiance
traceRay !scr !uc !objs !lgts !l !pmap !radius !m0 !r@(_, vvec) 
  | l >= max_trace = return radiance0
  | otherwise     = do
    case (calcIntersection r objs) of
      Nothing            -> return radiance0
      Just (t, p, n, m, io) -> do                 -- n: äº¤ç‚¹ã®æ³•ç·šãƒ™ã‚¯ãƒˆãƒ«

   : (ä¸­ç•¥)

        nvec' <- if rough sf == 0.0
          then return n
          else distributedNormal n (powerGlossy sf)
        let
          (rdir, cos1) = specularReflection nvec' vvec    --n'ã‚’ä½¿ã£ã¦åå°„ãƒ™ã‚¯ãƒˆãƒ«ã‚’æ±‚ã‚ã‚‹

   : (å¾Œç•¥)
```

å…‰æ²¢é¢ã®ä½œä¾‹ã‚’æ¬¡ã«ç¤ºã™(å›³3.1-a,b,c)ã€‚ãã‚Œãã‚Œé»„è‰²ã„ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã€é‡‘ã€é»„è‰²ã¿ã®ã‚¬ãƒ©ã‚¹ã§ã‚ã‚‹ã€‚å„çƒã¯å·¦ä¸Šã‹ã‚‰$roughness$ ãŒ0.0, 0.1, 0.2, 0.3, 0.4ã€ä¸‹æ®µãŒå·¦ã‹ã‚‰0.5, 0.6, 0.7, 0.8,1.0ã¨ã—ã¦ã‚ã‚‹ã€‚å¾ã€…ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒã¼ã‚„ã‘ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã ã‚ã†ã€‚ã¾ãŸã‚¬ãƒ©ã‚¹ã§ã¯çƒã‚’é€éã—ã¦é›†å…‰æ¨¡æ§˜ãŒã§ãã¦ã„ã‚‹ãŒã€ã“ã‚Œã‚‚$roughness$ã«å¿œã˜ã¦ã¼ã‚„ã‘ã¦ã„ã‚‹ã€‚ï¼ˆã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°=300ï¼‰

![å›³3.1-a.jpg](/images/raytracing-14/img3.1-a.jpg)
![å›³3.1-b.jpg](/images/raytracing-14/img3.1-b.jpg)
![å›³3.1-c.jpg](/images/raytracing-14/img3.1-c.jpg)

ä»–ã®ä½œä¾‹ã‚‚ç¤ºãã†ã€‚

![å›³3.2-a.jpg](/images/raytracing-14/img3.2-a.jpg)
![å›³3.2-b.jpg](/images/raytracing-14/img3.2-b.jpg)

(å›³3.2-a, b)

### 4. ã¾ã¨ã‚

ä»Šå›ã¯å…‰æ²¢é¢ã‚’æ‰±ãˆã‚‹ã‚ˆã†æ©Ÿèƒ½æ‹¡å¼µã—ãŸã€‚ä½œä¾‹ã‹ã‚‰ã‚‚ã‚ã‹ã‚‹ã‚ˆã†ã«ã¼ã‚“ã‚„ã‚Šã—ãŸãƒã‚¤ãƒ©ã‚¤ãƒˆãŒãã‚Œãªã‚Šã®å“è³ªã§è¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã¨æ€ã†ã€‚ç‰¹ã«é‡‘å±ã§ã¯ã¨ã¦ã‚‚æœ¬ç‰©ã‚‰ã—ãã¿ãˆã‚‹ã€‚

ä¸€æ–¹ã€ã“ã®æ‰‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯é¡é¢åå°„BRDFã¨ã—ã¦ç ”ç©¶ã•ã‚Œã¦ãŠã‚Šã€Cook-Torranceãƒ¢ãƒ‡ãƒ«ãŒã—ã°ã—ã°ä½¿ã‚ã‚Œã¦ã„ã‚‹ãã†ã ï¼ˆä¸‹å¼ï¼‰ã€‚([ç‰©ç†ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’æŸ”ã‚‰ã‹ãèª¬æ˜ã—ã¦ã¿ã‚‹ï¼ˆï¼”ï¼‰](https://qiita.com/emadurandal/items/76348ad118c36317ec5c))


$$
 f_{r,s} = \frac{DGF}{4 \langle n,l\rangle\langle n, v \rangle}
$$


å¼ä¸­ã®$D$ ã¯å¾®å°é¢æ³•ç·šåˆ†å¸ƒé–¢æ•°NDFã¨ã„ã„ã€ä»Šå›è¿½åŠ ã—ãŸãƒ©ãƒ³ãƒ€ãƒ ãªåå°„æ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã®ç”Ÿæˆã¨éå¸¸ã«æ·±ã„é–¢ä¿‚ãŒã‚ã‚Šãã†ãƒ»ãƒ»ãƒ»ã ãŒè©³ã—ãèª¿ã¹ã¦ã„ãªã„ã€‚ã¾ãŸã€$G$ã§è¡¨ã•ã‚Œã‚‹å¹¾ä½•æ¸›è¡°é …ã‚‚å¾®å°å¹³é¢ã®å‡¹å‡¸ã«ã‚ˆã‚‹å…‰ã®é®è”½ã‚’è¡¨ç¾ã—ã¦ã„ã‚‹ãã†ã§ã€ã‚ˆã‚Šãƒªã‚¢ãƒ«ãªç”»åƒç”Ÿæˆã«ã¯ä¸å¯æ¬ ã¨æ€ã‚ã‚Œã‚‹ãŒã“ã‚Œã‚‚ä»Šå¾Œã®å‹‰å¼·ãƒã‚¿ã§ã‚ã‚‹ã€‚ä»Šå¾Œç ”ç©¶ã®ä¸Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«çµ„ã¿å…¥ã‚Œã‚ˆã†ã€‚
